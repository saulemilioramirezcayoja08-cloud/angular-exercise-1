<div class="list-middle" (click)="closeMenuOnClickOutside($event)">
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p class="loading-text">Cargando compras...</p>
  </div>

  <div *ngIf="!isLoading && !hasSearched" class="empty-state">
    <p class="empty-title">{{ getEmptyMessage().title }}</p>
    <p class="empty-subtitle">{{ getEmptyMessage().subtitle }}</p>
  </div>

  <div *ngIf="!isLoading && hasSearched && purchases.length === 0" class="empty-state">
    <p class="empty-title">{{ getEmptyMessage().title }}</p>
    <p class="empty-subtitle">{{ getEmptyMessage().subtitle }}</p>
  </div>

  <table class="table" *ngIf="!isLoading && purchases.length > 0">
    <thead>
    <tr>
      <th class="header">Número</th>
      <th class="header">Estado</th>
      <th class="header">Usuario</th>
      <th class="header">Total</th>
      <th class="header">Items</th>
      <th class="header">Fecha Creación</th>
      <th class="header actions-header">Acciones</th>
    </tr>
    </thead>
    <tbody>
    <tr class="row" *ngFor="let purchase of purchases; trackBy: trackByPurchaseId">
      <td class="cell" (click)="onRowClick(purchase.id)">
        <span class="code">{{ purchase.number }}</span>
      </td>

      <td class="cell" (click)="onRowClick(purchase.id)">
        <span [class]="getBadgeClass(purchase.status)">{{ purchase.status }}</span>
      </td>

      <td class="cell" (click)="onRowClick(purchase.id)">
        <span class="label">{{ purchase.username || '-' }}</span>
      </td>

      <td class="cell" (click)="onRowClick(purchase.id)">
        <span class="value amount">{{ purchase.totalAmount }}</span>
      </td>

      <td class="cell" (click)="onRowClick(purchase.id)">
        <span class="value">{{ purchase.itemCount }}</span>
      </td>

      <td class="cell" (click)="onRowClick(purchase.id)">
        <span class="value datetime">{{ formatDateTime(purchase.createdAt) }}</span>
      </td>

      <td class="cell actions-cell">
        <div class="actions">
          <button type="button"
                  class="action-menu-btn"
                  (click)="toggleMenu(purchase.id, $event)"
                  [disabled]="purchase.isProcessing"
                  [class.active]="isMenuOpen(purchase.id)"
                  title="Acciones disponibles">
            <span class="dots" *ngIf="!purchase.isProcessing">⋮</span>
            <div *ngIf="purchase.isProcessing" class="mini-spinner"></div>
          </button>

          <div class="action-menu"
               *ngIf="isMenuOpen(purchase.id)"
               (click)="$event.stopPropagation()">

            <ng-container *ngIf="purchase.status === 'DRAFT'">
              <button class="menu-item"
                      (click)="onConfirmClick(purchase); closeMenu()"
                      [disabled]="purchase.isProcessing">
                <span class="menu-text">Confirmar Compra</span>
              </button>

              <button class="menu-item danger"
                      (click)="onCancelClick(purchase); closeMenu()"
                      [disabled]="purchase.isProcessing">
                <span class="menu-text">Cancelar Compra</span>
              </button>
            </ng-container>

            <ng-container *ngIf="purchase.status === 'CONFIRMED'">
              <div class="menu-item disabled">
                <span class="menu-text">Compra Confirmada</span>
              </div>
            </ng-container>

            <ng-container *ngIf="purchase.status === 'CANCELED'">
              <div class="menu-item disabled">
                <span class="menu-text">Compra Cancelada</span>
              </div>
            </ng-container>
          </div>
        </div>
      </td>
    </tr>
    </tbody>
  </table>
</div>
